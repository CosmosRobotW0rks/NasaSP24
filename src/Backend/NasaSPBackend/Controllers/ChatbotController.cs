using Microsoft.AspNetCore.Mvc;
using NasaSPBackend.Chatbot;
using NasaSPBackend.Chatbot.ChatbotSessionTracker;

namespace NasaSPBackend.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class ChatbotController(ILogger<ChatbotController> logger, ChatbotService chatbot, ChatbotSessionTrackerService sessionTrackerService) : ControllerBase
    {
        private readonly ILogger<ChatbotController> _logger = logger;
        private readonly ChatbotService _chatbot = chatbot;
        private readonly ChatbotSessionTrackerService _sessionTracker = sessionTrackerService;

        [HttpPost("createsession")]
        public IActionResult createSession()
        {
            var session = _chatbot.CreateSession();

            return Ok(session.SessionID);
        }

        [HttpPost("message")]
        public IActionResult message(string sid, string message)
        {
            if(message == "BOB")
            {
                return Ok("<img src=\"data:image/jpeg;base64,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\" width=\"400px\"/>");
            }


            var session = _sessionTracker.GetSessionBySessionID(sid);

            if(session == null)
            {
                _logger.LogWarning($"Session not found ({sid})");

                return BadRequest("session_not_found");
            }


            string? response = _chatbot.SendMessageAndGetResponse(session, message);

            if(response == null)
            {
                return BadRequest("Something went wrong");
            }

            return Ok(response);
        }
    }
}
